#!/usr/bin/env pwsh

# Script para gestionar migraciones de la base de datos SIGAV
# Uso: .\db-migrate.ps1 [comando]

param(
    [Parameter(Position=0)]
    [ValidateSet("update", "add", "remove", "list", "reset")]
    [string]$Command = "update",
    
    [Parameter(Position=1)]
    [string]$MigrationName = ""
)

Write-Host "üóÑÔ∏è  Gesti√≥n de migraciones de base de datos SIGAV" -ForegroundColor Green

# Verificar que los servicios est√©n ejecut√°ndose
try {
    docker compose -f docker-compose.dev.yml ps | Select-String "api" | Out-Null
} catch {
    Write-Host "‚ùå Los servicios no est√°n ejecut√°ndose. Ejecuta primero: .\start-dev.ps1" -ForegroundColor Red
    exit 1
}

switch ($Command) {
    "update" {
        Write-Host "üîÑ Aplicando migraciones..." -ForegroundColor Yellow
        docker compose -f docker-compose.dev.yml exec api dotnet ef database update
        Write-Host "‚úÖ Migraciones aplicadas correctamente" -ForegroundColor Green
    }
    
    "add" {
        if ([string]::IsNullOrEmpty($MigrationName)) {
            Write-Host "‚ùå Debes especificar un nombre para la migraci√≥n" -ForegroundColor Red
            Write-Host "Uso: .\db-migrate.ps1 add NombreMigracion" -ForegroundColor Yellow
            exit 1
        }
        Write-Host "‚ûï Creando nueva migraci√≥n: $MigrationName" -ForegroundColor Yellow
        docker compose -f docker-compose.dev.yml exec api dotnet ef migrations add $MigrationName
        Write-Host "‚úÖ Migraci√≥n creada correctamente" -ForegroundColor Green
    }
    
    "remove" {
        Write-Host "üóëÔ∏è  Eliminando √∫ltima migraci√≥n..." -ForegroundColor Yellow
        docker compose -f docker-compose.dev.yml exec api dotnet ef migrations remove
        Write-Host "‚úÖ √öltima migraci√≥n eliminada" -ForegroundColor Green
    }
    
    "list" {
        Write-Host "üìã Listando migraciones..." -ForegroundColor Yellow
        docker compose -f docker-compose.dev.yml exec api dotnet ef migrations list
    }
    
    "reset" {
        Write-Host "‚ö†Ô∏è  ADVERTENCIA: Esto eliminar√° todos los datos de la base de datos" -ForegroundColor Red
        $confirmation = Read-Host "¬øEst√°s seguro? (y/N)"
        if ($confirmation -eq "y" -or $confirmation -eq "Y") {
            Write-Host "üîÑ Reseteando base de datos..." -ForegroundColor Yellow
            docker compose -f docker-compose.dev.yml exec api dotnet ef database drop --force
            docker compose -f docker-compose.dev.yml exec api dotnet ef database update
            Write-Host "‚úÖ Base de datos reseteada correctamente" -ForegroundColor Green
        } else {
            Write-Host "‚ùå Operaci√≥n cancelada" -ForegroundColor Yellow
        }
    }
    
    default {
        Write-Host "‚ùå Comando no v√°lido" -ForegroundColor Red
        Write-Host "Comandos disponibles:" -ForegroundColor Yellow
        Write-Host "  update   - Aplicar migraciones pendientes" -ForegroundColor White
        Write-Host "  add      - Crear nueva migraci√≥n" -ForegroundColor White
        Write-Host "  remove   - Eliminar √∫ltima migraci√≥n" -ForegroundColor White
        Write-Host "  list     - Listar migraciones" -ForegroundColor White
        Write-Host "  reset    - Resetear base de datos (¬°CUIDADO!)" -ForegroundColor White
    }
}
