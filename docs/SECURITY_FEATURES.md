# üõ°Ô∏è Funcionalidades de Seguridad Avanzada

## üìã Resumen

Este documento describe las funcionalidades de seguridad avanzada implementadas en SIGAV para proteger las cuentas de usuario y detectar actividades sospechosas.

## üîê Funcionalidades Implementadas

### 1. **Verificaci√≥n de IP**
- **Bloqueo autom√°tico**: Las IPs que realizan m√∫ltiples intentos fallidos de login son bloqueadas autom√°ticamente
- **Tiempo de bloqueo**: 30 minutos por defecto (configurable)
- **Escalado**: El tiempo de bloqueo aumenta con cada intento fallido
- **Desbloqueo autom√°tico**: Las IPs se desbloquean autom√°ticamente despu√©s del tiempo configurado

### 2. **Detecci√≥n de Dispositivos**
- **Registro autom√°tico**: Cada dispositivo nuevo se registra autom√°ticamente
- **Identificaci√≥n**: Se detecta el tipo de dispositivo (desktop, mobile, tablet) y navegador
- **Ubicaci√≥n**: Se registra la ubicaci√≥n geogr√°fica del dispositivo (cuando est√° disponible)
- **Dispositivos confiables**: Los usuarios pueden marcar dispositivos como confiables
- **Notificaciones**: Se env√≠an notificaciones cuando se detecta un dispositivo nuevo

### 3. **Notificaciones de Login**
- **Login exitoso**: Notificaci√≥n cuando se inicia sesi√≥n desde un dispositivo no confiable
- **Nuevo dispositivo**: Notificaci√≥n cuando se detecta un dispositivo nuevo
- **Actividad sospechosa**: Notificaci√≥n cuando se detecta actividad sospechosa
- **Canales**: Email y SMS (configurable)

## üóÑÔ∏è Base de Datos

### Nuevas Tablas

#### `Dispositivos`
```sql
CREATE TABLE Dispositivos (
    Id SERIAL PRIMARY KEY,
    UsuarioId INTEGER NOT NULL,
    Nombre VARCHAR(100) NOT NULL,
    Tipo VARCHAR(100) NOT NULL,
    UserAgent VARCHAR(100) NOT NULL,
    IpAddress VARCHAR(45) NOT NULL,
    Ubicacion VARCHAR(100),
    FechaRegistro TIMESTAMP NOT NULL,
    UltimoAcceso TIMESTAMP NOT NULL,
    EsConfiable BOOLEAN NOT NULL DEFAULT FALSE,
    Activo BOOLEAN NOT NULL DEFAULT TRUE,
    FOREIGN KEY (UsuarioId) REFERENCES Usuarios(Id) ON DELETE CASCADE
);
```

#### `LogsSeguridad`
```sql
CREATE TABLE LogsSeguridad (
    Id SERIAL PRIMARY KEY,
    UsuarioId INTEGER,
    Tenant VARCHAR(100) NOT NULL,
    UsernameAttempted VARCHAR(100) NOT NULL,
    IpAddress VARCHAR(45) NOT NULL,
    UserAgent VARCHAR(500) NOT NULL,
    TipoEvento VARCHAR(50) NOT NULL,
    Resultado VARCHAR(20) NOT NULL,
    Detalles VARCHAR(500),
    Ubicacion VARCHAR(100),
    Timestamp TIMESTAMP NOT NULL,
    Jti VARCHAR(100),
    FOREIGN KEY (UsuarioId) REFERENCES Usuarios(Id) ON DELETE SET NULL
);
```

#### `IpsBloqueadas`
```sql
CREATE TABLE IpsBloqueadas (
    Id SERIAL PRIMARY KEY,
    IpAddress VARCHAR(45) NOT NULL,
    Razon VARCHAR(100) NOT NULL,
    FechaBloqueo TIMESTAMP NOT NULL,
    FechaExpiracion TIMESTAMP NOT NULL,
    Detalles VARCHAR(500),
    Activo BOOLEAN NOT NULL DEFAULT TRUE,
    IntentosFallidos INTEGER NOT NULL DEFAULT 0
);
```

## üîß Configuraci√≥n

### Variables de Entorno

```bash
# Configuraci√≥n de seguridad
AUTH_MAX_FAILED_ATTEMPTS=5
AUTH_ACCOUNT_LOCKOUT_MINUTES=15
AUTH_IP_BLOCK_MINUTES=30
AUTH_IP_BLOCK_THRESHOLD=10

# Notificaciones
NOTIFICATIONS_EMAIL_ENABLED=true
NOTIFICATIONS_SMS_ENABLED=false
NOTIFICATIONS_EMAIL_FROM=noreply@sigav.com
```

### Configuraci√≥n en appsettings.json

```json
{
  "Security": {
    "MaxFailedAttempts": 5,
    "AccountLockoutMinutes": 15,
    "IpBlockMinutes": 30,
    "IpBlockThreshold": 10,
    "DeviceTrustRequired": false,
    "LocationTracking": true
  },
  "Notifications": {
    "EmailEnabled": true,
    "SmsEnabled": false,
    "EmailFrom": "noreply@sigav.com"
  }
}
```

## üöÄ API Endpoints

### Login Mejorado

**POST** `/api/auth/login`

**Request:**
```json
{
  "tenant": "empresa_demo",
  "usernameOrEmail": "admin@demo.local",
  "password": "admin123"
}
```

**Response:**
```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "expiresIn": 900,
  "tokenType": "Bearer",
  "user": {
    "id": "1",
    "name": "Admin Demo",
    "email": "admin@demo.local"
  },
  "tenant": "empresa_demo",
  "isNewDevice": true,
  "deviceName": "Chrome en Windows"
}
```

## üìä Logs y Auditor√≠a

### Tipos de Eventos Registrados

- `login_exitoso`: Login exitoso
- `login_fallido`: Login fallido
- `dispositivo_nuevo`: Nuevo dispositivo detectado
- `ip_bloqueada`: IP bloqueada
- `actividad_sospechosa`: Actividad sospechosa detectada

### Resultados

- `ok`: Operaci√≥n exitosa
- `fail`: Operaci√≥n fallida
- `blocked`: Acceso bloqueado
- `suspicious`: Actividad sospechosa

## üîç Monitoreo y Alertas

### M√©tricas Clave

- **Intentos fallidos por IP**: Monitoreo de IPs sospechosas
- **Dispositivos nuevos**: Detecci√≥n de dispositivos no reconocidos
- **Logins desde ubicaciones inusuales**: Alertas geogr√°ficas
- **Patrones de uso an√≥malos**: Detecci√≥n de comportamiento sospechoso

### Alertas Autom√°ticas

1. **M√∫ltiples intentos fallidos**: Bloqueo autom√°tico de IP
2. **Nuevo dispositivo**: Notificaci√≥n al usuario
3. **Login desde ubicaci√≥n inusual**: Notificaci√≥n de seguridad
4. **Actividad sospechosa**: Bloqueo temporal y notificaci√≥n

## üõ†Ô∏è Implementaci√≥n T√©cnica

### Servicios

#### `ISecurityService`
```csharp
public interface ISecurityService
{
    // Verificaci√≥n de IP
    Task<bool> IsIpBlockedAsync(string ipAddress);
    Task BlockIpAsync(string ipAddress, string reason, int minutes = 30);
    Task UnblockIpAsync(string ipAddress);
    
    // Detecci√≥n de dispositivos
    Task<Dispositivo?> GetDeviceAsync(int userId, string userAgent, string ipAddress);
    Task<Dispositivo> RegisterDeviceAsync(int userId, string userAgent, string ipAddress, string? location = null);
    Task UpdateDeviceLastAccessAsync(int deviceId);
    Task<bool> IsDeviceTrustedAsync(int userId, string userAgent, string ipAddress);
    
    // Logs de seguridad
    Task LogSecurityEventAsync(string tenant, string usernameAttempted, string ipAddress, 
        string userAgent, string tipoEvento, string resultado, int? userId = null, 
        string? detalles = null, string? ubicacion = null, string? jti = null);
    
    // Notificaciones
    Task SendLoginNotificationAsync(Usuario usuario, string ipAddress, string userAgent, string? location = null);
    Task SendNewDeviceNotificationAsync(Usuario usuario, Dispositivo dispositivo);
    Task SendSuspiciousActivityNotificationAsync(Usuario usuario, string ipAddress, string reason);
}
```

### Flujo de Login Mejorado

1. **Validaci√≥n de IP**: Verificar si la IP est√° bloqueada
2. **Autenticaci√≥n**: Validar credenciales
3. **Detecci√≥n de dispositivo**: Identificar si es un dispositivo conocido
4. **Registro de dispositivo**: Registrar dispositivo nuevo si es necesario
5. **Notificaciones**: Enviar notificaciones seg√∫n el caso
6. **Logs**: Registrar evento de seguridad
7. **Respuesta**: Devolver token con informaci√≥n adicional

## üîÆ Pr√≥ximas Mejoras

### Funcionalidades Planificadas

1. **Autenticaci√≥n de dos factores (2FA)**
   - SMS/Email
   - TOTP (Google Authenticator)
   - Backup codes

2. **Gesti√≥n de sesiones**
   - Sesiones m√∫ltiples
   - Cerrar sesi√≥n remota
   - Historial de sesiones

3. **An√°lisis de comportamiento**
   - Machine Learning para detectar patrones an√≥malos
   - Score de riesgo por sesi√≥n
   - Alertas inteligentes

4. **Integraci√≥n con servicios externos**
   - Geolocalizaci√≥n avanzada
   - Verificaci√≥n de IP (VPN/Tor detection)
   - Threat intelligence feeds

## üìù Notas de Implementaci√≥n

### Consideraciones de Seguridad

- **Privacidad**: La ubicaci√≥n se almacena de forma opcional
- **Consentimiento**: Los usuarios deben consentir el tracking de dispositivos
- **Retenci√≥n**: Los logs se mantienen por un per√≠odo limitado
- **Acceso**: Solo administradores pueden acceder a logs detallados

### Performance

- **√çndices**: Se han creado √≠ndices optimizados para consultas frecuentes
- **Caching**: Los dispositivos confiables se cachean para mejorar performance
- **Async**: Todas las operaciones son as√≠ncronas para no bloquear el login

### Escalabilidad

- **Rate limiting**: Implementado a nivel de IP
- **Distributed caching**: Preparado para Redis
- **Microservices**: Arquitectura preparada para separaci√≥n de servicios
